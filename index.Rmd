---
title: "AshplotR"
author: "Ian Matthews & Joshua Pike"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: cerulean
    code_download: true
    includes:
      in_header: GA_script.html
---

# 1.0 Introduction

This script can be used to create bi-plots and Harker plots of all tephra major elemental data. It includes: tips for flitering data, interactive exploration of the data, more complex plots, using kernel densities to delimit chemical envelopes, and some discussion on identifying useful elements for discrimination via multivariate analysis. Guidance for saving plots as .svg or .pdf files is also provided. All the code used to produce this document is downloadable as an RMarkdown file to the right of this page and should appear for each specific plot generated. To run this you will require r and RStudio. We are happy for you to use, share and improve our code, but would ask that you cite this as a point of origin for the code.

## Load packages

We first load in packages required to generate the plots and manipulate the data. You may need to install these packages in r or update them to work correctly.

```{r message = FALSE, warning = FALSE, echo=TRUE}
library(ggplot2)
library(factoextra)
library(readr)
library(psych)
library(compositions)
library(gganimate)
library(cowplot)
library(tidyverse)
library(gt)
library(plotly)
library(svglite)
library(png)
library(here)
library(ggdensity)
library(ggrepel)
library(viridis)
```


# 2.0 Loading your data

Data should be placed within a 'Data' folder created in your project directory. As this is a Markdown script the 'here' package is used to ensure that project links do not break when moving scripts around, however you may not need to do this if you have a preferred data storage approach. As long as you start a new R project and drop this script into it then set up 'Data' and 'Script' folders then it will work. Data files should be in .csv format and contain the group of the tephra as column 1 under the title "id" (see console output below for format). Loaded here are some data for core ODP-980 in the North Atlantic and a terrestrial site from the UK called MT. These data were published by Candy et al. (2021) and the paper can be found [here](https://doi.org/10.1002/jqs.3367).

```{r}
chem <- here::here("Data","ODP_norm.csv") %>% read.csv()
```

## 2.1 Check your data has loaded correctly
We can first just inspect the data in the console using the 'head' command, and then summarise it using the describe function of the psych package. These commands produce a couple of basic tables which should allow you to check whether you have correctly loaded the data you wish to analyse.
```{r}
head(chem)
describe(chem)
```

## 2.2 Better tables in R.
The main problem with the console output from R is that produces tables that are not pretty to view. This can largely be addressed by the 'gt' package which produces far nicer output in an html format. 
The following script produces a summary table of mean values and number of analyses in your data.

```{r echo=FALSE}
chem_sum <- chem %>% group_by(id) %>% dplyr::summarise(                                            
                                                       count=n(),
                                                       SiO2.= mean(SiO2),
                                                       sd1 = sd(SiO2),
                                                       TiO2. = mean(TiO2),
                                                       sd2 = sd(TiO2),
                                                       Al2O3. = mean(Al2O3),
                                                       sd3 = sd(Al2O3),
                                                       FeOt = mean(FeO),
                                                       sd4 = sd(FeO),
                                                       MnO.= mean(MnO),
                                                       sd5 = sd(MnO),
                                                       MgO.= mean(MgO),
                                                       sd6 = sd(MgO),
                                                       CaO.= mean(CaO),
                                                       sd7 = sd(CaO),
                                                       Na2O. = mean(Na2O),
                                                       sd8 = sd(Na2O),
                                                       K2O. = mean(K2O),
                                                       sd9 = sd(K2O),
                                                       P2O5. = mean(P2O5),
                                                       sd10 = sd(P2O5),
                                                       Total.=mean(Total),
                                                       sd11 = sd(Total))
chem_sum <- chem_sum %>% mutate(across(where(is.numeric), ~ round(., digits = 2)))
chem_sum <- chem_sum %>% rename(layer = id, n = count)


gt(chem_sum)
```

## 2.3 Make TAS calculations

To calculate for the TAS plot the data require normalisation of the data. The data used here has been normalised already so this step is largely redundant, but this is not the case for all tephra data and you might prefer to utilise unormalised data for your analyses, especially if you are interested in the effects of analytical totals on your data. This code does not modify your orignal data so can be safely run for both normalised and unormalised data. It is required for the TAS plot so should be run regardless of the state of your data.

```{r}
TAS_x <- (100/ chem [["Total"]]) * chem [["SiO2"]]
TAS_y <- (100/ chem [["Total"]]) * (chem [["K2O"]] + chem [["Na2O"]])

chem <- cbind(chem, TAS_x, TAS_y)
```

# 3.0 Filtering data
It is possible your datasheet contains multiple types of tephra chemistry which would benefit from filtering before plotting. I suggest this is carried out initially by using silica values as a divisor. Rhyolites >68% silica would be a case for this. However, it might be worth plotting everything first before then selecting a filter to ensure vital data is not being excluded. Here we continue with all data being plotted before filtering later in the script when making comparisons.
```{r}
#chem <- filter(chem, SiO2 >68) ## code is commented order to retain all data at this stage.
```



# 4.0 Plotting your data

First we generate a series of plots from all possible pairs of elements.

```{r}
p1 <- ggplot(chem, aes(x = TAS_x, y = TAS_y, fill = id, shape = id)) # this uses the TAS calculations made earlier in step 2.3.
p2 <- ggplot(chem, aes(x = SiO2, y = TiO2, fill = id, shape = id))
p3 <- ggplot(chem, aes(x = SiO2, y = Al2O3, fill = id, shape = id))
p4 <- ggplot(chem, aes(x = SiO2, y = FeO,  fill = id, shape = id))
p5 <- ggplot(chem, aes(x = SiO2, y = MnO,  fill = id, shape = id))
p6 <- ggplot(chem, aes(x = SiO2, y = MgO,  fill = id, shape = id))
p7 <- ggplot(chem, aes(x = SiO2, y = CaO,  fill = id, shape = id))
p8 <- ggplot(chem, aes(x = SiO2, y = Na2O,  fill = id, shape = id))
p9 <- ggplot(chem, aes(x = SiO2, y = K2O,  fill = id, shape = id))
p47 <- ggplot(chem, aes(x = SiO2, y = K2O, fill = id, shape = id))
p10 <- ggplot(chem, aes(x = SiO2, y = P2O5,  fill = id, shape = id))
p11 <- ggplot(chem, aes(x = TiO2, y = Al2O3,  fill = id, shape = id))
p12 <- ggplot(chem, aes(x = TiO2, y = FeO,  fill = id, shape = id))
p13 <- ggplot(chem, aes(x = TiO2, y = MnO,  fill = id, shape = id))
p14 <- ggplot(chem, aes(x = TiO2, y = MgO,  fill = id, shape = id))
p15 <- ggplot(chem, aes(x = TiO2, y = CaO,  fill = id, shape = id))
p16 <- ggplot(chem, aes(x = TiO2, y = Na2O,  fill = id, shape = id))
p17 <- ggplot(chem, aes(x = TiO2, y = K2O,  fill = id, shape = id))
p18 <- ggplot(chem, aes(x = TiO2, y = P2O5,  fill = id, shape = id))
p19 <- ggplot(chem, aes(x = Al2O3, y = FeO,  fill = id, shape = id))
p20 <- ggplot(chem, aes(x = Al2O3, y = MnO,  fill = id, shape = id))
p21 <- ggplot(chem, aes(x = Al2O3, y = MgO,  fill = id, shape = id))
p22 <- ggplot(chem, aes(x = Al2O3, y = CaO,  fill = id, shape = id))
p23 <- ggplot(chem, aes(x = Al2O3, y = Na2O,  fill = id, shape = id))
p24 <- ggplot(chem, aes(x = Al2O3, y = K2O,  fill = id, shape = id))
p25 <- ggplot(chem, aes(x = Al2O3, y = P2O5,  fill = id, shape = id))
p26 <- ggplot(chem, aes(x = FeO, y = MnO,  fill = id, shape = id))
p27 <- ggplot(chem, aes(x = FeO, y = MgO,  fill = id, shape = id))
p28 <- ggplot(chem, aes(x = FeO, y = CaO,  fill = id, shape = id))
p29 <- ggplot(chem, aes(x = FeO, y = Na2O,  fill = id, shape = id))
p30 <- ggplot(chem, aes(x = FeO, y = K2O,  fill = id, shape = id))
p31 <- ggplot(chem, aes(x = FeO, y = P2O5,  fill = id, shape = id))
p32 <- ggplot(chem, aes(x = MnO, y = MgO,  fill = id, shape = id))
p33 <- ggplot(chem, aes(x = MnO, y = CaO,  fill = id, shape = id))
p34 <- ggplot(chem, aes(x = MnO, y = Na2O,  fill = id, shape = id))
p35 <- ggplot(chem, aes(x = MnO, y = K2O,  fill = id, shape = id))
p36 <- ggplot(chem, aes(x = MnO, y = P2O5,  fill = id, shape = id))
p37 <- ggplot(chem, aes(x = MgO, y = CaO,  fill = id, shape = id))
p38 <- ggplot(chem, aes(x = MgO, y = Na2O,  fill = id, shape = id))
p39 <- ggplot(chem, aes(x = MgO, y = K2O,  fill = id, shape = id))
p40 <- ggplot(chem, aes(x = MgO, y = P2O5,  fill = id, shape = id))
p41 <- ggplot(chem, aes(x = CaO, y = Na2O,  fill = id, shape = id))
p42 <- ggplot(chem, aes(x = CaO, y = K2O,  fill = id, shape = id))
p43 <- ggplot(chem, aes(x = CaO, y = P2O5,  fill = id, shape = id))
p44 <- ggplot(chem, aes(x = Na2O, y = K2O,  fill = id, shape = id))
p45 <- ggplot(chem, aes(x = Na2O, y = P2O5,  fill = id, shape = id))
p46 <- ggplot(chem, aes(x = K2O, y = P2O5,  fill = id, shape = id))
```


## 4.1 Custom tephra theme
To ensure consistency and to provide a short cut from coding it every time, we set up a custom tephra plotting theme. This means all of our plots will have the same sized fonts etc...


```{r}
Tephra.theme <-theme_bw()+theme(axis.title.x=element_text(size=16),
                                axis.title.y=element_text(size=16), 
                                axis.text.x=element_text(size=16),
                                axis.text.y=element_text(size=16))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank())
```

## 4.2 Custom colour palette

The hex numbers below specify a custom colour palette for plotting. These can be altered but were slected in order to help those with colour vision deficiencies, and this should be considered when making changes. At present 35 layers can be plotted using this pallete. If you have more than 35 groups of data you will either have to specify additional colours or consider splitting your dataset. The latter might be more appropriate for improving the final clarity in the plots. 

```{r}
chempalette <- c("#209A24","#A769EE","#B4C428","#e30303","#000000","#EF139D","#3A700F","#5288FF","#E64701","#7F9AF5","#F36D20","#0B3075","#C18522","#9634A6","#1D7D46","#80ddb8","#7CBC92","#B10E89","#384B27","#F896FD","#C6A766","#20628E","#9C0323","#C3AFE0","#572D24","#FF79A2","#3E6D6F","#E18C63","#6F2B40","#DF9FB4", "#291700", "#7e005b", "#00597a" , "#7b003a",	"#470600")
```

The palette is known as "chempalette".

# 5.0 Biplots {.tabset .tabset-pills}

We first generate the simple bi-plots of each element. This initial exploration approach facilitates data checking for unusual analyses and permits the identification of elements with significant variability.

## TAS plot Le Maitre et al. (2002)
```{r TAS plot, echo=FALSE}
p1 <- p1 + geom_point(aes(fill = id), size=4, alpha=0.8) +
  #xlab(expression (SiO[2]~"(wt%)")) + use these for outputting subscript characters for saved svg or pdf plots.
  xlab("SiO2 (wt%)") +
  #ylab(expression (Na[2]*O~"+"~K[2]*O~"(wt%)")) +
  ylab("Na2O + K2O (wt%)") +
  scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) + 
  geom_segment(x=77,y=0,xend=69,yend=8)+ 
  geom_segment(x=69, y=8,xend=69,yend=13)+geom_segment(x=41, y=7,xend=52.5,yend=14)+
  geom_segment(x=52.5,y=14,xend=57.6,yend=11.7)+
  geom_segment(x=45,y=0,xend=45,yend=5)+
  geom_segment(x=45,y=5,xend=63,yend=14.56)+
  geom_segment(x=52,y=0,xend=52,yend=5)+
  geom_segment(x=52,y=5,xend=63,yend=7)+
  geom_segment(x=57,y=0,xend=57,yend=5.9)+
  geom_segment(x=63,y=0,xend=63,yend=7)+
  geom_segment(x=45,y=5,xend=52,yend=5)+
  geom_segment(x=52,y=5,xend=49.4,yend=7.3)+
  geom_segment(x=57,y=5.9,xend=53,yend=9.3)+
  geom_segment(x=63,y=7,xend=57.6,yend=11.7)+
  geom_segment(x=49.4,y=7.3,xend=45,yend=9.4)+
  geom_segment(x=53,y=9.3,xend=48.4,yend=11.5)+
  geom_segment(x=41,y=0,xend=41,yend=7)+
  geom_segment(x=52.5,y=14,xend=49,yend=15.5)+
  geom_segment(x=41,y=3,xend=45,yend=3)+
  geom_segment(x=63,y=7,xend=69,yend=8)+
  scale_x_continuous(limits=c(40, 80), expand = c(0, 0)) + 
  scale_y_continuous(limits=c(0, 16), expand = c(0, 0)) +
  annotate("text", x = c(76,67.5,59,54,48,42.5,48.5,53,57,63,43,48,53,57,42), y = c(6,5.2,4,3,2.5,1.5,6,7.5,8.8,11,7,10,12,14.5,13), label = c("R","O3","O2","O1","B","Pc","S1","S2","S3","T","U1","U2","U3","Ph","F")) +
  Tephra.theme
p1
```

## SiO2 VS TiO2
```{r echo=FALSE}
p2 <- p2 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("SiO2 (wt%)")+ylab("TiO2 (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  Tephra.theme
p2
```

## SiO2 VS Al2O3
```{r echo=FALSE}
p3 <- p3 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("SiO2 (wt%)")+ylab("Al2O3 (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  Tephra.theme
p3
```

## SiO2 VS FeO
```{r echo=FALSE}
p4 <- p4 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("SiO2 (wt%)")+ylab("FeO (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  Tephra.theme
p4
```

## SiO2 VS MnO
```{r echo=FALSE}
p5 <- p5 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("SiO2 (wt%)")+ylab("MnO (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  Tephra.theme
p5
```

## SiO2 VS MgO
```{r echo=FALSE}
p6 <- p6 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("SiO2 (wt%)")+ylab("MgO (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  Tephra.theme
p6
```

## SiO2 VS CaO
```{r echo=FALSE}
p7 <- p7 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("SiO2 (wt%)")+ylab("CaO (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  Tephra.theme
p7
```

## SiO2 VS Na2O
```{r echo=FALSE}
p8 <- p8 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("SiO2 (wt%)")+ylab("Na2O (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  Tephra.theme
p8
```

## SiO2 VS K2O
```{r echo=FALSE}
p9 <- p9 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("SiO2 (wt%)")+ylab("K2O (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  Tephra.theme
p9
```

```{r echo=FALSE}
p47 <- p47 + geom_point(aes(fill = id), size=4, alpha=0.8)+
  xlab("SiO2 (wt%)")+ylab("K2O (wt%)")+
  scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  geom_segment(x=48,y=1.6,xend=52,yend=2.4)+ 
  geom_segment(x=52, y=2.4,xend=56,yend=3.2)+
  geom_segment(x=56, y=3.2,xend=63,yend=4.0)+
  geom_segment(x=48,y=1.2,xend=52,yend=1.5)+
  geom_segment(x=52,y=1.5,xend=56,yend=1.8)+
  geom_segment(x=56,y=1.8,xend=63,yend=2.4)+
  geom_segment(x=63,y=2.4,xend=70,yend=3.0)+
  geom_segment(x=48,y=0.3,xend=52,yend=0.5)+
  geom_segment(x=52,y=0.5,xend=56,yend=0.7)+
  geom_segment(x=56,y=0.7,xend=63,yend=1.0)+
  geom_segment(x=63,y=1.0,xend=70,yend=1.3)+
  geom_segment(x=70,y=1.3,xend=80,yend=1.6)+
  Tephra.theme
p47
```

## SiO2 VS P2O5
```{r echo=FALSE}
p10 <- p10 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("SiO2 (wt%)")+ylab("P2O5 (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  Tephra.theme
p10
```

## TiO2 VS Al2O3
```{r echo=FALSE}
p11 <- p11 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("TiO2 (wt%)")+ylab("Al2O3 (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  Tephra.theme
p11
```

## TiO2 vs FeO
```{r echo=FALSE}
p12 <- p12 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("TiO2 (wt%)")+ylab("FeO (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  Tephra.theme
p12
```

## TiO2 vs MnO
```{r echo=FALSE}
p13 <- p13 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("TiO2 (wt%)")+ylab("MnO (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  Tephra.theme
p13
```

## TiO2 VS MgO
```{r echo=FALSE}
p14 <- p14 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("TiO2 (wt%)")+ylab("MgO (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  Tephra.theme
p14
```

## TiO2 VS CaO
```{r echo=FALSE}
p15 <- p15 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("TiO2 (wt%)")+ylab("CaO (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  Tephra.theme
p15
```

## TiO2 VS Na2O
```{r echo=FALSE}
p16 <- p16 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("TiO2 (wt%)")+ylab("Na2O (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  Tephra.theme
p16
```

## TiO2 VS K2O
```{r echo=FALSE}
p17 <- p17 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("TiO2 (wt%)")+ylab("K2O (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  Tephra.theme
p17
```

## TiO2 VS P2O5
```{r echo=FALSE}
p18 <- p18 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("TiO2 (wt%)")+ylab("P2O5 (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  Tephra.theme
p18
```

## Al2O3 VS FeO
```{r echo=FALSE}
p19 <- p19 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("Al2O3 (wt%)")+ylab("FeO (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  Tephra.theme
p19
```

## Al2O3 VS MnO
```{r echo=FALSE}
p20 <- p20 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("Al2O3 (wt%)")+ylab("MnO (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  Tephra.theme
p20
```

## Al2O3 VS MgO
```{r}
p21 <- p21 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("Al2O3 (wt%)")+ylab("MgO (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  Tephra.theme
p21
```

## Al2O3 VS CaO
```{r echo=FALSE}
p22 <- p22 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("Al2O3 (wt%)")+ylab("CaO (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  Tephra.theme
p22
```

## Al2O3 VS Na2O
```{r echo=FALSE}
p23 <- p23 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("Al2O3 (wt%)")+ylab("Na2O (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  Tephra.theme
p23
```

## Al2O3 VS K2O
```{r echo=FALSE}
p24 <- p24 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("Al2O3 (wt%)")+ylab("K2O (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  Tephra.theme
p24
```

## Al2O3 VS P2O5
```{r echo=FALSE}
p25 <- p25 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("Al2O3 (wt%)")+ylab("P2O5 (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  Tephra.theme
p25
```

## FeO VS MnO
```{r echo=FALSE}
p26 <- p26 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("FeO (wt%)")+ylab("MnO (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  Tephra.theme
p26
```

## FeO vs MgO
```{r echo=FALSE}
p27 <- p27 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("FeO (wt%)")+ylab("MgO (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  Tephra.theme
p27
```

## FeO vs CaO
```{r echo=FALSE}
p28 <- p28 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("FeO (wt%)")+ylab("CaO (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  Tephra.theme
p28
```

## FeO VS Na2O
```{r echo=FALSE}
p29 <- p29 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("FeO (wt%)")+ylab("Na2O (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  Tephra.theme
p29
```

## FeO VS K2O
```{r echo=FALSE}
p30 <- p30 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("FeO (wt%)")+ylab("K2O (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  Tephra.theme
p30
```

## FeO VS P2O5
```{r echo=FALSE}
p31 <- p31 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("FeO (wt%)")+ylab("P2O5 (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  Tephra.theme
p31
```

## MnO VS MgO
```{r echo=FALSE}
p32 <- p32 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("MnO (wt%)")+ylab("MgO (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  Tephra.theme
p32
```

## MnO VS CaO
```{r echo=FALSE}
p33 <- p33 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("MnO (wt%)")+ylab("CaO (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  Tephra.theme
p33
```

## MnO VS Na2O
```{r echo=FALSE}
p34 <- p34 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("MnO (wt%)")+ylab("Na2O (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  Tephra.theme
p34
```

## MnO VS K2O
```{r echo=FALSE}
p35 <- p35 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("MnO (wt%)")+ylab("K2O (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  Tephra.theme
p35
```

## MnO VS P2O5
```{r echo=FALSE}
p36 <- p36 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("MnO (wt%)")+ylab("P2O5 (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  Tephra.theme
p36
```

## MgO VS CaO
```{r echo=FALSE}
p37 <- p37 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("MgO (wt%)")+ylab("CaO (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  Tephra.theme
p37
```

## MgO VS Na2O
```{r echo=FALSE}
p38 <- p38 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("MgO (wt%)")+ylab("Na2O (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  Tephra.theme
p38
```

## MgO VS K2O
```{r echo=FALSE}
p39 <- p39 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("MgO (wt%)")+ylab("K2O (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  Tephra.theme
p39
```

## MgO VS P2O5
```{r echo=FALSE}
p40 <- p40 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("MgO (wt%)")+ylab("P2O5 (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  Tephra.theme
p40
```

## CaO VS Na2O
```{r echo=FALSE}
p41 <- p41 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("CaO (wt%)")+ylab("Na2O (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  Tephra.theme
p41
```

## CaO VS K2O
```{r echo=FALSE}
p42 <- p42 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("CaO (wt%)")+ylab("K2O (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  Tephra.theme
p42
```

## CaO VS P2O5
```{r echo=FALSE}
p43 <- p43 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("CaO (wt%)")+ylab("P2O5 (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  Tephra.theme
p43
```

## Na2O VS K2O
```{r echo=FALSE}
p44 <- p44 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("Na2O (wt%)")+ylab("K2O (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  Tephra.theme
p44
```

## Na2O VS P2O5
```{r echo=FALSE}
p45 <- p45 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("Na2O (wt%)")+ylab("P2O5 (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  Tephra.theme
p45
```

## K2O VS P2O5
```{r echo=FALSE}
p46 <- p46 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("K2O (wt%)")+ylab("P2O5 (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +
  Tephra.theme
p46
```

## 5.1  Saving plots

We propose exporting your individual plots in .svg format. This is a vector file format that preserves your data without size and scaling issues. It is also readable and editable by software like Adobe Illustrator, Affinity Designer, or free alternatives like Inkscape. Using the file structure presented here the all plots can be named appropriately and will be saved in the Output -> Plots folder. The width and height and dpi outputs can be altered but override the preview functions in Rstudio and we recommend that you view the svg file directly in you preferred image editor to understand how it might look.

```{r}
ggsave( filename = file.path("Script", "Output","Plots","fig1.svg"), plot = p1, width = 12, height = 6, dpi = 300)
```

# {-}

# 6.0 Multivariate analysis {.tabset .tabset-pills}
Multivariate analysis via ordination is often a helpful way of exploring your data. It permits the identification of useful elements for discrimination and facilitates dimension reduction. Unfortunately, percentage data can have problematic covariation and should be 'freed' from their compositional sum where possible. This can be achieved via undertaking a centred log-ratio transform. This is performed using the code given below

```{r}
chem_multi <- chem[ -c(1,6,11,12,13,14,15)] ## check columns to drop. Currently dropping id, MnO, P2O5, Total, and TAS calculations to perform the clr transform.
chem_multi[is.na(chem_multi)] <- 0.005 # replace NAs with half the detection limit
chem_multi_clr <- clr(chem_multi)
cmclr <- as.data.frame(chem_multi_clr)
head(cmclr) # This permits us the opportunity to view the centred log-ratio dataset.
```

We can summarise the importance of the resulting principal components by summarizing how much of the total variance is captured by each principal component.

## 6.1 PCA summary
```{r echo=FALSE}
pcascores <- prcomp(cmclr)
summ <- as.data.frame(summary(pcascores)$importance)
summ <- tibble::rownames_to_column(summ, "Information")
summ %>% gt()
```
If this has captured a significant amount of variation it would be worth plotting the output in order to identify the important variables in determining the changes observed.

## 6.3 PCA scores scree plot
```{r warning = FALSE, echo=FALSE}
fviz_eig(pcascores)

```

This is a visual representation of the summary table showing the percentage of the total variance explained by each dimension.

## 6.4 Variables PCA plot
```{r warning = FALSE, echo=FALSE}
fviz_pca_var(pcascores, col.var = "contrib", # Color by contributions to the PC
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE     # Avoid text overlapping
)
```


## 6.5 Loadings dimension 1
```{r echo=FALSE}
fviz_contrib(pcascores, choice="var", axes = 1,fill = "#00AFBB", color = "black") +theme_minimal() +theme(axis.text.x = element_text(angle=45))
```

## 6.6 Loadings dimension 2

```{r echo=FALSE}
fviz_contrib(pcascores, choice="var", axes = 2,fill = "#00AFBB", color = "black") +theme_minimal() +theme(axis.text.x = element_text(angle=45))
```

## 6.7 PCA - Biplot
```{r warning = FALSE, echo=FALSE}
fviz_pca_biplot(pcascores, repel = FALSE,
                col.var = "#2E9FDF", # Variables color
                col.ind = "#696969"  # Individuals color
)
```

## 6.8 PCA - grouped
```{r warning = FALSE, echo=FALSE}
pcout <- pcascores$x
id <- as.data.frame(chem$id)
id <- unlist(id)
id <- as_data_frame(id)
pcout <- cbind(id, pcout)
colnames(pcout)[colnames(pcout)=="value"] <- "id"
pc1plot <- ggplot(pcout, aes(x = PC1, y = PC2, fill = id, shape = id))
pc1plot <- pc1plot + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("PC1")+ylab("PC2")+theme_bw()+theme(axis.title.x=element_text(size=16), axis.title.y=element_text(size=16), axis.text.x=element_text(size=16), axis.text.y=element_text(size=16))+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+scale_colour_manual(values = chempalette) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_manual(values = chempalette) +
  scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))

  pc1plot
```

# {-}

# 7.0 Interactive figures {.tabset .tabset-pills}

The function ggplotly within the plotly package is extremely useful for interactively examining data. ggplotly plots allow you to zoom into areas of interest and turn layers on and off as well as saving low resolution .png files of zoomed sections of your plots. We refer to these as iPlots (interactive plots) in order to distinguish them from static plots presented above. These are excellent for generating quick plots to support your inferences about your data. The plots can be exported as .png files.

## iTAS plot
```{r warning = FALSE, echo=FALSE}
ggplotly(p1, width = 1000, height = 800)
```

## iFeO-CaO
```{r warning = FALSE, echo=FALSE}
ggplotly(p28, width = 1000, height = 800)
```
## iK-lines
```{r warning = FALSE, echo=FALSE}
ggplotly(p47, width = 1000, height = 800, dynamicTicks = TRUE)
```
## iTiO2 vs Al2O3
```{r warning = FALSE, echo=FALSE}
ggplotly(p11, width = 1000, height = 800, dynamicTicks = TRUE)
```


## iK2O vs CaO
```{r warning = FALSE, echo=FALSE}
ggplotly(p42, width = 1000, height = 800, dynamicTicks = TRUE)
```



## {-}

# 8.0 Saving all figures to a .pdf


```{r}
l <- list(p1, p2, p3, p4, p5, p6, p7, p8, p9, p47, p10, p11, p12, p13, p14, p15, p16, p17, p18, p19, p20, p21, p22, p23, p24, p25, p26, p27, p28, p29, p30, p31, p32, p33, p34, p35, p36, p37, p38, p39, p40, p41, p42, p43, p44, p45, p46)
pdf("allplotsout.pdf", width = 12, height = 6)
invisible(lapply(l, print))
dev.off()
```

# 9.0 Harker plot
It is frequently useful to plot all of the collected elemental data against SiO[2]. This permits an assessment of groupings within the data and which elements might be useful discriminators. Additionally, wt% K2O vs SiO2 can further classify the tephra to low, mid and high Potassium values. The dividing lines included here are from xxxxxxxx.
```{r fig.height = 10, fig.width = 18}
g1 <- plot_grid(p1 + theme(legend.position = "none"), 
                p2 + theme(legend.position = "none"),
                p3 + theme(legend.position="none"),
                p4 + theme(legend.position="none"),
                p5 + theme(legend.position="none"),
                p6 + theme(legend.position="none"),
                p7 + theme(legend.position="none"),
                p8 + theme(legend.position="none"), 
                p47 + theme(legend.position="none"), 
                p10 + theme(legend.position="none"),
                labels = c("A", "B", "C", "D", "E", "F", "G", "H", "I", "J"), align = "b")
legend <- get_legend(p1)
legplot <- plot_grid(legend)
px <- plot_grid( g1, rel_widths = c(4, 1))
l2 <- list(px,legplot)
pdf("Script/Output/Plots/Harkerplot.pdf", width = 30, height = 20)
invisible(lapply(l2, print))
dev.off()

ggsave( filename = file.path("Script","Output","Plots","Harker.svg"), plot = px, width = 30, height = 20, dpi = 300)

print(g1)

```

# 10.0 Other useful plots

## 10.1 Creating an inset within a figure
```{r warning=FALSE }
p100 <- ggplot(chem, aes(x = TAS_x, y = TAS_y, fill = id, shape = id))
p100 <- p100 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("SiO2 (wt%)")+ylab("Na2O+K2O (wt%)")+
  scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
  scale_fill_manual(values = chempalette) +geom_segment(x=77,y=0,xend=69,yend=8)+ 
  geom_segment(x=69, y=8,xend=69,yend=13)+geom_segment(x=41, y=7,xend=52.5,yend=14)+
  geom_segment(x=52.5,y=14,xend=57.6,yend=11.7)+geom_segment(x=45,y=0,xend=45,yend=5)+
  geom_segment(x=45,y=5,xend=63,yend=14.56)+geom_segment(x=52,y=0,xend=52,yend=5)+
  geom_segment(x=52,y=5,xend=63,yend=7)+geom_segment(x=57,y=0,xend=57,yend=5.9)+
  geom_segment(x=63,y=0,xend=63,yend=7)+geom_segment(x=45,y=5,xend=52,yend=5)+
  geom_segment(x=52,y=5,xend=49.4,yend=7.3)+geom_segment(x=57,y=5.9,xend=53,yend=9.3)+
  geom_segment(x=63,y=7,xend=57.6,yend=11.7)+geom_segment(x=49.4,y=7.3,xend=45,yend=9.4)+
  geom_segment(x=53,y=9.3,xend=48.4,yend=11.5)+geom_segment(x=41,y=0,xend=41,yend=7)+
  geom_segment(x=52.5,y=14,xend=49,yend=15.5)+geom_segment(x=41,y=3,xend=45,yend=3)+
  geom_segment(x=63,y=7,xend=69,yend=8)+
  scale_x_continuous(limits=c(74, 79), expand = c(0, 0)) + ## set x axis of insert
  scale_y_continuous(limits=c(6, 10.5), expand = c(0, 0)) + ## set y axis of insert
  theme_bw()+theme(axis.title.x=element_text(size=9), axis.title.y=element_text(size=9), 
                   axis.text.x=element_text(size=9), axis.text.y=element_text(size=9))+ ## change the text size as neccessary
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "none")
fig_in <- p1 + annotation_custom(ggplotGrob(p100), xmin = 40, xmax = 56, ymin = 7, ymax = 16) + ## place the insert
   annotate("rect", xmin = 74, xmax = 79, ymin = 6, ymax = 10.5,
  alpha = .2) ## use this to highlight the area of the insert plot
```

```{r fig.height = 10, fig.width = 18}
ggsave( filename = file.path("Script", "Output","Plots","insert_plot.svg"), plot = fig_in, width = 10, height = 6, dpi = 300)

print(fig_in)
```

## 10.2 Creating a HDR plot to simplify your data.
Simplifying the data we create to make more visually compelling figures can be achieved using highest density regions. The following code permits this as an addition to the previously created plots and as new plots. It can be added easily to any of the previously created plots by changing the p code. Visibility of the density regions can be applied to just reference data or entire datasets. Opacity is varied using the alpha command and the probability range can be altered in the 'probs' argument. You may need to vary the x and y axes in order to fit the full range in to the plot. These types of plots are best used for giving better eruptive chemical envelopes (fields) than hand drawing around existing data. 

```{r}
p28den <- p28 +
geom_hdr(stat= "hdr", method = "kde", na.rm = TRUE, inherit.aes = TRUE, alpha  = 0.3, xlim = c(0,100), ylim = c(0,30), smooth = TRUE, n = 1000, probs = c(0.75))
print(p28den)


```

## 10.3 Faceted plots to deal with lots of data
The kde plots are interesting but messy and still have lots of overplotting. This is not ideal for data visualisation. While it may be helpful to vary the colours or opacity, there is only so much that this can acheive. If you have particularly messy data like the ODP-980 dataset I'd suggest creating plot 'facets' using the following code.

```{r}
p28den_facet <- p28 +
geom_hdr(method = "kde", alpha  = 0.5, xlim = c(0,100), ylim = c(0,30), show.legend = FALSE, smooth = TRUE, n = 1000, probs = c(0.95)) +
  facet_wrap(~ id)


print(p28den_facet)
```

The facet removes some of the complexity and permits the kde to be visualised more clearly, but arguably you lose some of the key information about total ranges of chemical data. In the second faceted plot (below) we remove the kernel density information and use the total dataset as a background to the facets in order to understand the total range and our own individual samples. This requires a little bit of data manipulation in order to create two datasets, one for the total data spread and another for the facets.

```{r}
chem2 <- dplyr::select(chem, -Total) # creates the second dataset fpr plotting
chem2 <- rename(chem2, id2=id) # removes confusion over column names
f19 <- ggplot(chem, aes(x = FeO, y = CaO,  fill = id, shape = id)) # creates a new plot of FeO and CaO.

f19 <- f19 + 
    geom_point(data = chem2, inherit.aes = FALSE, aes(x=FeO, y = CaO, shape = id2), colour = "grey70") + ## adds all the data to the plot using a grey colour scheme
  geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("FeO (wt%)")+ylab("CaO (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+ # adds all the data again but retain the groups
  scale_fill_manual(values = chempalette) + ## adds standard colours
  Tephra.theme + # adds standard theme
  coord_cartesian(xlim = c(0,20), ylim = c(0,15)) + # scale the plots to display the data effectively
  facet_wrap(~ id) # facets the diagram using id in the main dataset.

print(f19)

ggsave( filename = file.path("Script", "Output","Plots","faceted plot.pdf"), plot = f19, width = 30, height = 20, units = "cm", dpi = 300)



```

# 11.0 Comparing unknown samples
All of the above code can be used on unknown samples and for your own data exploration. It can also be used to explore a reference dataset in order to understand what chemical plots can be used to best differentiate tephra from different volcanoes and even different eruptions. However, some times it is better to keep the exploration and analysis phases separate. This section looks at importing a specific unknown tephra and making direct comparisons to a reference dataset. It uses the ODP-980 data presented above as a record of volcanism in the North Atlantic during MIS-11c and then compares this with our unknown tephra from a site in England called Marks Tey. First we load and summarise the data as before but then we look at filtering and presenting the data more clearly.

This code loads our unknown data from a normalised dataset called MT_norm.csv. We then present all of the data in a table.
```{r}
unknowns <- here::here("Data","MT_norm.csv") %>% read.csv()
gt(unknowns)
```

Like before this is useful to use to understand that our data has loaded correctly, but a summary table might be more useful. This is performed using the code from section 2.2.
```{r}
unknown_sum <- unknowns %>% group_by(id2) %>% dplyr::summarise(                                            
                                                       count=n(),
                                                       SiO2.= mean(SiO2),
                                                       sd1 = sd(SiO2),
                                                       TiO2. = mean(TiO2),
                                                       sd2 = sd(TiO2),
                                                       Al2O3. = mean(Al2O3),
                                                       sd3 = sd(Al2O3),
                                                       FeOt = mean(FeO),
                                                       sd4 = sd(FeO),
                                                       MnO.= mean(MnO),
                                                       sd5 = sd(MnO),
                                                       MgO.= mean(MgO),
                                                       sd6 = sd(MgO),
                                                       CaO.= mean(CaO),
                                                       sd7 = sd(CaO),
                                                       Na2O. = mean(Na2O),
                                                       sd8 = sd(Na2O),
                                                       K2O. = mean(K2O),
                                                       sd9 = sd(K2O),
                                                       P2O5. = mean(P2O5),
                                                       sd10 = sd(P2O5),
                                                       Total.=mean(Total),
                                                       sd11 = sd(Total))
unknown_sum <- unknown_sum %>% mutate(across(where(is.numeric), ~ round(., digits = 2)))
unknown_sum %>% rename(layer = id2, n = count , SiO2 = SiO2., TiO2 = TiO2.)

gt(unknown_sum)
```
We evidently have a relatively homogenous highly silicic tephra with average silica values of 77.29 %wt and FeOt values below 3%wt. We could undertake further plots to check this out, but it might also be an examination of the tabular data is sufficient for this purpose. This helps us to filter our possible correlatives. We can also restrict our possible correlatives using other stratigraphic and chronological data. This might be plausible time windows that the tephra could occur or other factors. The ODP-980 data have some additional information that might aid some discrimination. The publication lists sections of Ice rafted debris (IRD) which reflect mixtures of ash layers and therefore not primary tephra deposits. We will exclude these here in order to only deal with potential primary ash layers.

```{r}
chem_red <- filter(chem, IRD == "NO") #We might want to filter our data by age or other stratigraphic information. here we are excluding layers identified as ice rafted debris. This can be achieved using additional columns in the input data sheet. All of the plotting code will ignore these unless told otherwise.

chem_red <- filter(chem_red, SiO2 >68 & FeO <4) # Our unknown sample is a rhyolite so we can now employ our filtering by value, we can also exclude some of the high iron examples in the ODP-980 dataset.

c28 <- ggplot(chem_red, aes(x = SiO2, y = CaO, fill = id, shape = id)) # create a new plot using the reduced chemical comparison data
c28 <- c28 + 
  geom_hdr(method = "kde", alpha  = 0.4, xlim = c(0,100), ylim = c(0,30), show.legend = TRUE, smooth = TRUE, n = 500, probs = c(0.95), color = "black") + # Add the ODP-980 data as a kde field for comparison this uses 95% probability ranges for comparison.
   scale_fill_viridis(discrete = TRUE) + # We will use the Viridis scale for now as this gives relatively good differentiation.
    geom_point(data = unknowns, inherit.aes = FALSE, aes(x=SiO2, y = CaO, shape = id2, fill = id2), size=4, alpha=0.7, show.legend = FALSE) + # we take our unknown data and plot it as points
  xlab("SiO2 (wt%)") + # Label our axes
  ylab("CaO (wt%)") + 
  scale_shape_manual(values=c(1:5,7,11, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25)) +
  Tephra.theme # add the tephra theme.
print(c28)
```

We can see that only samples 54.79-54.83 and 51.09-51.13 have any overlap with our unknown at 95% probability. It is worth noting here that this is in part down to our filtering of the data in the previous step. We need to be sure that we are not excluding important data when undertaking this step otehrwise our resulting kdes can be strongly altered. Therefore it is also sensible to plot the raw point data for comparison also. The interactive plot below uses the same elements but permits exploration of the data. From this we can see that 54.79-54.83 is the best match for our sample on these elements.

```{r}
u28 <- ggplot(chem_red, aes(x = SiO2, y = CaO,  fill = id, shape = id))
u28 <- u28 + geom_point(aes(fill = id), size=4, alpha=0.8)+xlab("SiO2 (wt%)")+ylab("CaO (wt%)")+scale_shape_manual(values=c(21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25, 21:25))+
      geom_point(data = unknowns, inherit.aes = FALSE, aes(x=SiO2, y = CaO, shape = id2, fill = id2), size=4, alpha=0.8) +
  scale_fill_manual(values = chempalette) +
  Tephra.theme

ggplotly(u28, width = 1000, height = 800)
```



# References
R. W. Le Maitre (editor), A. Streckeisen, B. Zanettin, M. J. Le Bas, B. Bonin, P. Bateman, G. Bellieni, A. Dudek, S. Efremova, J. Keller, J. Lamere, P. A. Sabine, R. Schmid, H. Sorensen, and A. R. Woolley, Igneous Rocks: A Classification and Glossary of Terms, Recommendations of the International Union of Geological Sciences, Subcommission of the Systematics of Igneous Rocks. Cambridge University Press, 2002.

# Papers using versions of this code.

Walsh, A.A., Blockley, S.P., Milner, A.M. and Martin-Puertas, C., 2023. Updated age constraints on key tephra markers for NW Europe based on a high-precision varve lake chronology. Quaternary Science Reviews, 300, p.107897. [read it here](https://www.sciencedirect.com/science/article/pii/S0277379122005285#fig2)

Carter‐Champion, A., Abrook, A.M., Pike, J.H., Matthews, I.P., Palmer, A.P. and Lowe, J.J., 2022. Ice‐sheet deglaciation and Loch Lomond Readvance in the eastern Cairngorms: implications of a Lateglacial sediment record from Glen Builg. Journal of Quaternary Science, 37(8), pp.1332-1347. [read it here](https://onlinelibrary.wiley.com/doi/10.1002/jqs.3448)

Walsh, A.A., Blockley, S.P., Milner, A.M., Matthews, I.P. and Martin-Puertas, C., 2021. Complexities in European Holocene cryptotephra dispersal revealed in the annually laminated lake record of Diss Mere, East Anglia. Quaternary Geochronology, 66, p.101213.  [read it here](https://www.sciencedirect.com/science/article/pii/S1871101421000637)
 
Palmer, A.P., Matthews, I.P., Lowe, J.J., MacLeod, A. and Grant, R., 2020. A revised chronology for the growth and demise of Loch Lomond Readvance (‘Younger Dryas’) ice lobes in the Lochaber area, Scotland. Quaternary Science Reviews, 248, p.106548.[read it here](https://www.sciencedirect.com/science/article/pii/S0277379120305102)
 
Lowe, J., Matthews, I., Mayfield, R., Lincoln, P., Palmer, A., Staff, R. and Timms, R., 2019. On the timing of retreat of the Loch Lomond (‘Younger Dryas’) Readvance icefield in the SW Scottish Highlands and its wider significance. Quaternary Science Reviews, 219, pp.171-186.[read it here](https://www.sciencedirect.com/science/article/pii/S0277379119301957)


